{% assign goal_num = include.goal | plus: 0 %}
{% assign pledged_num = include.pledged | plus: 0 %}
{% assign stretch_goals = include.stretch_goals %}
{% assign stretch_hidden = include.stretch_hidden %}

{% comment %} Calculate max threshold for bar scaling {% endcomment %}
{% assign max_threshold = goal_num %}
{% assign show_final_marker = false %}
{% if stretch_goals %}
  {% for s in stretch_goals %}
    {% assign s_threshold = s.threshold | plus: 0 %}
    {% if s_threshold > max_threshold %}
      {% assign max_threshold = s_threshold %}
    {% endif %}
  {% endfor %}
{% else %}
  {% comment %} No stretch goals: if pledged exceeds goal, use pledged as max and show Final marker {% endcomment %}
  {% if pledged_num > goal_num %}
    {% assign max_threshold = pledged_num %}
    {% assign show_final_marker = true %}
  {% endif %}
{% endif %}

{% comment %} Calculate progress percentage relative to max threshold, capped at 100% {% endcomment %}
{% assign exceeded_max = false %}
{% if max_threshold and max_threshold > 0 %}
  {% assign pct = pledged_num | times: 100 | divided_by: max_threshold | round: 0 %}
  {% if pct > 100 %}
    {% assign exceeded_max = true %}
    {% assign pct = 100 %}
  {% endif %}
{% else %}
  {% assign pct = 0 %}
{% endif %}

{% comment %} Calculate goal marker position {% endcomment %}
{% if max_threshold and max_threshold > 0 %}
  {% assign goal_pct = goal_num | times: 100 | divided_by: max_threshold | round: 0 %}
{% else %}
  {% assign goal_pct = 100 %}
{% endif %}

{% assign goal_met = false %}
{% if pledged_num >= goal_num %}
  {% assign goal_met = true %}
{% endif %}

<div class="progress-wrap" data-live-stats data-campaign-slug="{{ include.campaign_slug }}" data-goal="{{ goal_num }}" data-pledged="{{ pledged_num }}" data-max-threshold="{{ max_threshold }}">
  {% if include.progress_background %}
  <img src="{{ include.progress_background }}" alt="" class="progress-wrap__bg" aria-hidden="true">
  {% endif %}
  <div class="progress-bar{% if exceeded_max %} progress-bar--exceeded{% endif %}">
    <span style="width: {{ pct }}%"></span>
    {% comment %} 1/3 goal marker {% endcomment %}
    {% assign one_third = goal_num | divided_by: 3 %}
    {% assign one_third_pct = one_third | times: 100 | divided_by: max_threshold | round: 0 %}
    {% assign one_third_met = false %}
    {% if pledged_num >= one_third %}{% assign one_third_met = true %}{% endif %}
    <div class="progress-marker progress-marker--milestone{% if one_third_met %} progress-marker--achieved{% endif %}" style="left: {{ one_third_pct }}%">
      <span class="progress-marker__dot"></span>
      <span class="progress-marker__label">
        <span class="progress-marker__amount">{{ one_third | money_short }}</span>
        <span class="progress-marker__desc">1/3</span>
      </span>
    </div>
    {% comment %} 2/3 goal marker {% endcomment %}
    {% assign two_thirds = goal_num | times: 2 | divided_by: 3 %}
    {% assign two_thirds_pct = two_thirds | times: 100 | divided_by: max_threshold | round: 0 %}
    {% assign two_thirds_met = false %}
    {% if pledged_num >= two_thirds %}{% assign two_thirds_met = true %}{% endif %}
    <div class="progress-marker progress-marker--milestone{% if two_thirds_met %} progress-marker--achieved{% endif %}" style="left: {{ two_thirds_pct }}%">
      <span class="progress-marker__dot"></span>
      <span class="progress-marker__label">
        <span class="progress-marker__amount">{{ two_thirds | money_short }}</span>
        <span class="progress-marker__desc">2/3</span>
      </span>
    </div>
    {% comment %} Goal marker {% endcomment %}
    <div class="progress-marker progress-marker--goal{% if goal_met %} progress-marker--achieved{% endif %}" style="left: {{ goal_pct }}%">
      <span class="progress-marker__dot"></span>
      <span class="progress-marker__label">
        <span class="progress-marker__amount">{{ goal_num | money_short }}</span>
        <span class="progress-marker__desc">Goal!</span>
      </span>
    </div>
    {% comment %} Final marker (when exceeded goal with no stretch goals) {% endcomment %}
    {% if show_final_marker %}
    <div class="progress-marker progress-marker--final progress-marker--achieved" style="left: 100%">
      <span class="progress-marker__dot"></span>
      <span class="progress-marker__label">
        <span class="progress-marker__amount">{{ pledged_num | money_short }}</span>
        <span class="progress-marker__desc">Final</span>
      </span>
    </div>
    {% endif %}
    {% comment %} Stretch goal markers {% endcomment %}
    {% if stretch_goals %}
      {% assign prev_met = goal_met %}
      {% for s in stretch_goals %}
        {% assign s_threshold = s.threshold | plus: 0 %}
        {% assign s_pct = s_threshold | times: 100 | divided_by: max_threshold | round: 0 %}
        {% assign s_achieved = false %}
        {% if pledged_num >= s_threshold %}
          {% assign s_achieved = true %}
        {% endif %}
        {% comment %} Determine if unlocked: always show if stretch_hidden is false, otherwise require previous goal met {% endcomment %}
        {% if stretch_hidden == false %}
          {% assign s_unlocked = true %}
        {% else %}
          {% assign s_unlocked = prev_met %}
        {% endif %}
        <div class="progress-marker progress-marker--stretch{% if s_achieved %} progress-marker--achieved{% endif %}{% unless s_unlocked %} progress-marker--locked{% endunless %}" style="left: {{ s_pct }}%" data-threshold="{{ s_threshold }}">
          <span class="progress-marker__dot"></span>
          <span class="progress-marker__label">
            <span class="progress-marker__amount">{{ s_threshold | money_short }}</span>
            <span class="progress-marker__desc">
              {% if s_unlocked %}
                {{ s.title }}
              {% else %}
                ???
              {% endif %}
            </span>
          </span>
        </div>
        {% assign prev_met = s_achieved %}
      {% endfor %}
    {% endif %}
  </div>
  <div class="progress-meta">
    <strong data-live-pledged>{{ pledged_num | money }}</strong> of {{ goal_num | money }}
    {% if include.state == 'upcoming' and include.start_date %}
      · Starts {{ include.start_date | date: "%b %-d, %Y" }}
    {% elsif include.deadline %}
      {% if include.state == 'post' %}
        · Ended {{ include.deadline | date: "%b %-d, %Y" }}
      {% else %}
        · Ends {{ include.deadline | date: "%b %-d, %Y" }}
      {% endif %}
    {% endif %}
  </div>
</div>
